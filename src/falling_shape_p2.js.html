<!doctype html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no" />
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        #application {

        }
    </style>
    <script src="../libs/stats.min.js"></script>
    <script src="../libs/playcanvas-stable.js"></script>
    <!--<script src="../libs/ammo.js"></script>-->
    <script src="../libs/p2.min.js"></script>
    <script src="../libs/p2-integration.js"></script>
</head>

<body>
<!-- The canvas element -->
<canvas id="application-canvas" width="506" height="900"></canvas>

<!-- The script -->
<script>
    let stats = new Stats();
    stats.showPanel(0); // 0: fps, 1: ms, 2: mb, 3+: custom
    document.body.appendChild( stats.dom );

    // ***********    Initialize application   *******************
    var canvas = document.getElementById("application-canvas");

    // Create the application and start the update loop
    var app = new pc.Application(canvas);
    app.start();

    addP2Integration();

    // Set the canvas to fill the window and automatically change resolution to be the same as the canvas size
    app.setCanvasFillMode(pc.FILLMODE_FILL_WINDOW);
    app.setCanvasResolution(pc.RESOLUTION_AUTO);


    window.addEventListener('resize', ()=> {
        app.resizeCanvas();
    });

    app.scene.ambientLight = new pc.Color(0.2, 0.2, 0.2);

    // Set the gravity for our rigid bodies
    //app.systems.rigidbody.setGravity(0, -9.8, 0);

    app.root.addComponent("script");
    app.root.script.create("p2World", {
        attributes: {
            defaultFriction: 0,
            gravity: new pc.Vec2(0, -9.8)
        }
    });

    function createMaterial (color) {
        var material = new pc.PhongMaterial();
        material.diffuse = color;
        // we need to call material.update when we change its properties
        material.update();
        return material;
    }

    // create a few materials for our objects
    var white = createMaterial(new pc.Color(1, 1, 1));
    var red = createMaterial(new pc.Color(1, 0, 0));
    var green = createMaterial(new pc.Color(0, 1, 0));
    var blue = createMaterial(new pc.Color(0, 0, 1));
    var yellow = createMaterial(new pc.Color(1, 1, 0));

    // ***********    Create our floor   *******************

    var floor = new pc.Entity();
    floor.addComponent("model", {
        type: "box"
    });

    // make the floor white
    floor.model.material = white;

    // scale it
    floor.setLocalScale(10, 1, 10);
    floor.setPosition(0, -10, 0);

    //floor.rotate(20, 0, 0);

    // add a rigidbody component so that other objects collide with it
    floor.addComponent("rigidbody", {
        type: "static",
        restitution: 0.5
    });

    // add a collision component
    floor.addComponent("collision", {
        type: "box",
        halfExtents: new pc.Vec3(5, 0.5, 5)
    });

    floor.root.addComponent("script");
    floor.root.script.create("p2Body", {
        attributes: {
            type: p2.Body.STATIC
        }
    });

    floor.root.script.create("p2Box", {
        attributes: {

        }
    });


    // add the floor to the hierarchy
    floor.enabled = true;
    app.root.addChild(floor);

    // ***********    Create lights   *******************

    // make our scene prettier by adding a directional light
    var light = new pc.Entity();
    light.addComponent("light", {
        type: "directional",
        color: new pc.Color(1, 1, 1),
        castShadows: true,
        shadowBias: 0.05,
        normalOffsetBias: 0.05,
        shadowResolution: 2048
    });

    // set the direction for our light
    light.setLocalEulerAngles(45, 30, 0);

    // Add the light to the hierarchy
    app.root.addChild(light);

    // ***********    Create camera    *******************

    // Create an Entity with a camera component
    var camera = new pc.Entity();
    camera.addComponent("camera", {
        clearColor: new pc.Color(0.5, 0.5, 0.8),
        farClip: 50
    });

    // add the camera to the hierarchy
    app.root.addChild(camera);

    // Move the camera a little further away
    camera.translate(0, 10, 15);
    camera.lookAt(0, 0, 0);

    // ***********    Create templates    *******************

    // A sphere...
    var sphereTemplate = new pc.Entity();
    sphereTemplate.addComponent("model", {
        type: "sphere",
        castShadows: true
    });

    sphereTemplate.addComponent("rigidbody", {
        type: "dynamic",
        mass: 50,
        restitution: 0.5
    });

    sphereTemplate.addComponent("collision", {
        type: "sphere",
        radius: 0.5
    });

    // make the sphere green
    sphereTemplate.model.material = green;
    sphereTemplate.setPosition(0, 10, 0);

    sphereTemplate.root.addComponent("script");
    sphereTemplate.root.script.create("p2Body", {
        attributes: {
            type: p2.Body.DYNAMIC,
            mass: 50
        }
    });
    sphereTemplate.root.script.create("p2Circle", {
        attributes: {
            radius: 0.5,
        }
    });


    sphereTemplate.enabled = true;
    app.root.addChild(sphereTemplate);

    //sphereTemplate.rigidbody.teleport(0, 10, 0);

    // add all the templates to an array so that
    // we can randomly spawn them
    var templates = [sphereTemplate];

    // disable the templates because we don't want them to be visible
    // we'll just use them to clone other Entities
    templates.forEach(function (template) {
        //template.enabled = false;
    });

    // ***********    Update Function   *******************

    // initialize variables for our update function
    var timer = 0;
    var count = 40;

    // Set an update function on the application's update event
    app.on("update", function (dt) {

        stats.begin();
        // create a falling box every 0.2 seconds
        if (count > 0) {
            timer -= dt;
            if (timer <= 0) {
                /*count--;
                timer = 0.2;

                // Clone a random template and position it above the floor
                var template = templates[Math.floor(pc.math.random(0, templates.length))];
                var clone = template.clone();
                // enable the clone because the template is disabled
                clone.enabled = true;

                app.root.addChild(clone);

                clone.rigidbody.teleport(pc.math.random(-1, 1), 10, pc.math.random(-1, 1));*/
            }
        }

//        floor.rotate(2 * dt, 0, 0);

        stats.end();
    });

</script>
</body>
</html>
